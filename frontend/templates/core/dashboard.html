{% extends "core/base.html" %}

{% block title %}Analytics Dashboard{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}
{% block page_subtitle %}
    <span class="text-muted">
        <i class="far fa-calendar-alt me-1"></i> 
        <span class="formatted-date" data-date="{{ start_date }}"></span> to 
        <span class="formatted-date" data-date="{{ end_date }}"></span>
    </span>
{% endblock %}

{% block extra_css %}
<style>
    /* --- 1. NEW NAV DESIGN (High Contrast Active State) --- */
    .segmented-nav {
        background: var(--nav-segment-bg);
        padding: 6px;
        border-radius: 12px;
        display: inline-flex;
        gap: 6px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
        z-index: 0;
    }

    .nav-segment-link {
        padding: 10px 24px;
        border-radius: 8px;
        color: var(--text-muted);
        text-decoration: none !important;
        font-weight: 600;
        font-size: 0.9rem;
        position: relative;
        overflow: hidden; 
        z-index: 1;
        transition: all 0.2s ease;
        display: flex; align-items: center; gap: 8px;
    }

    /* HOVER: Gradient Sweep (Kept this as you liked it) */
    .nav-segment-link::before {
        content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #ffffff 0%, #334155 100%); 
        opacity: 0; z-index: -1; transition: opacity 0.3s ease; border-radius: 8px;
    }
    .nav-segment-link:hover { color: white; transform: translateY(-1px); }
    .nav-segment-link:hover::before { opacity: 1; }

    /* ACTIVE STATE: High Contrast Solid Color */
    .nav-segment-active {
        background: var(--primary-color) !important; /* Solid Brand Color */
        color: white !important; /* White Text */
        box-shadow: 0 4px 12px rgba(0, 110, 255, 0.021); /* Matching Glow */
        transform: translateY(-1px);
    }
    /* Disable gradient on active items so the solid color shows */
    .nav-segment-active::before { display: none; }
    .nav-segment-active:hover { color: white !important; opacity: 0.9; }

    
    /* --- 2. CARD & FILTER FIXES --- */
    .filter-card { 
        background: var(--card-bg);
        border-radius: 12px;
        overflow: visible !important; 
        z-index: 100 !important; 
        position: relative; 
        min-height: 260px; 
        transition: none !important;
        border: 1px solid var(--border-color);
    }

    /* --- 3. METRIC CARDS --- */
    .metric-card { 
        background: var(--card-bg);
        border-left: 5px solid #0d6efd; 
        height: 100%; 
        transition: transform 0.2s; 
        cursor: pointer; 
        z-index: 1; 
        color: var(--text-main);
    }
    .metric-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-soft); }
    .card-pre { border-left-color: #fd7e14; }
    .card-post { border-left-color: #198754; }

    /* --- 4. DROPDOWN FIXES --- */
    .dropdown-menu-form { min-width: 260px; z-index: 1055 !important; }
    .form-control-sm, .form-select-sm, .btn-sm { height: 34px; font-size: 0.85rem; }
    
    .popover { border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 12px; }
    .popover-header { background: var(--bg-body); font-weight: 600; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
    .popover-body { background: var(--card-bg); color: var(--text-main); }
</style>
{% endblock %}

{% block content %}
    
    <div class="d-flex justify-content-center mb-5">
        <div class="segmented-nav">
            <a href="?view=Marketing&start={{ start_date }}&end={{ end_date }}" class="nav-segment-link {% if view_mode == 'Marketing' %}nav-segment-active{% endif %}">
                <i class="fas fa-bullhorn"></i> Marketing
            </a>
            <a href="?view=Sales&start={{ start_date }}&end={{ end_date }}" class="nav-segment-link {% if view_mode == 'Sales' %}nav-segment-active{% endif %}">
                <i class="fas fa-funnel-dollar"></i> Sales
            </a>
            <a href="?view=Design&start={{ start_date }}&end={{ end_date }}" class="nav-segment-link {% if view_mode == 'Design' %}nav-segment-active{% endif %}">
                <i class="fas fa-drafting-compass"></i> Design
            </a>
            <a href="?view=Operations&start={{ start_date }}&end={{ end_date }}" class="nav-segment-link {% if view_mode == 'Operations' %}nav-segment-active{% endif %}">
                <i class="fas fa-hard-hat"></i> Operations
            </a>
            <a href="?view=Purchase&start={{ start_date }}&end={{ end_date }}" class="nav-segment-link {% if view_mode == 'Purchase' %}nav-segment-active{% endif %}">
                <i class="fas fa-shopping-cart"></i> Purchase
            </a>
            <a href="?view=Finance&start={{ start_date }}&end={{ end_date }}" class="nav-segment-link {% if view_mode == 'Finance' %}nav-segment-active{% endif %}">
                <i class="fas fa-coins"></i> Finance
            </a>
        </div>
    </div>

    <div class="card mb-5 filter-card shadow-sm">
        <div class="card-body p-4">
            <form method="get" class="row g-3" id="filterForm">
                <input type="hidden" name="view" value="{{ view_mode }}">

                <div class="col-md-3 border-end pe-3">
                    <label class="form-label small fw-bold text-muted text-uppercase mb-1">Time Period</label>
                    <div class="input-group input-group-sm">
                        <input type="date" name="start" class="form-control border-0 bg-light" value="{{ start_date }}">
                        <span class="input-group-text border-0 bg-light text-muted">-</span>
                        <input type="date" name="end" class="form-control border-0 bg-light" value="{{ end_date }}">
                    </div>
                </div>

                <div class="col-md-3 border-end px-3">
                    <label class="form-label small fw-bold text-muted text-uppercase mb-1">Roles / Perspective</label>
                    <select name="metric_role" class="form-select form-select-sm fw-bold border-0 bg-light shadow-sm text-primary">
                        <option value="All Roles" {% if current_role == 'All Roles' %}selected{% endif %}>All Roles</option>
                        
                        {% if view_mode == 'Marketing' %}
                            <optgroup label="Marketing">
                                <option value="Marketing Head" {% if current_role == 'Marketing Head' %}selected{% endif %}>Marketing Head</option>
                                <option value="Marketing Lead" {% if current_role == 'Marketing Lead' %}selected{% endif %}>Marketing Lead</option>
                            </optgroup>
                        {% endif %}

                        {% if view_mode == 'Sales' %}
                            <optgroup label="Sales">
                                <option value="Sales Head" {% if current_role == 'Sales Head' %}selected{% endif %}>Sales Head</option>
                                <option value="Sales Lead" {% if current_role == 'Sales Lead' %}selected{% endif %}>Sales Lead</option>
                            </optgroup>
                        {% endif %}

                        {% if view_mode == 'Design' %}
                            <optgroup label="Design">
                                <option value="DH" {% if current_role == 'DH' %}selected{% endif %}>Design Head (DH)</option>
                                <option value="DM" {% if current_role == 'DM' %}selected{% endif %}>Design Manager (DM)</option>
                                <option value="ID" {% if current_role == 'ID' %}selected{% endif %}>ID (Designer)</option>
                                <option value="3D" {% if current_role == '3D' %}selected{% endif %}>3D Visualizer</option>
                            </optgroup>
                        {% endif %}

                        {% if view_mode == 'Operations' %}
                            <optgroup label="Operations">
                                <option value="Cluster/BU Head" {% if current_role == 'Cluster/BU Head' %}selected{% endif %}>Cluster/BU Head</option>
                                <option value="SPM/PM" {% if current_role == 'SPM/PM' %}selected{% endif %}>Project Manager (PM)</option>
                                <option value="SOM/OM" {% if current_role == 'SOM/OM' %}selected{% endif %}>Ops Manager (OM)</option>
                                <option value="SS" {% if current_role == 'SS' %}selected{% endif %}>Site Supervisor</option>
                            </optgroup>
                        {% endif %}
                        
                        {% if view_mode == 'Purchase' %}
                            <optgroup label="Purchase">
                                <option value="Purchase Head" {% if current_role == 'Purchase Head' %}selected{% endif %}>Purchase Head</option>
                                <option value="Procurement Mgr" {% if current_role == 'Procurement Mgr' %}selected{% endif %}>Procurement Manager</option>
                                <option value="Procurement Exec" {% if current_role == 'Procurement Exec' %}selected{% endif %}>Procurement Executive</option>
                            </optgroup>
                        {% endif %}

                        {% if view_mode == 'Finance' %}
                             <option value="Finance Head" {% if current_role == 'Finance Head' %}selected{% endif %}>Finance Head</option>
                        {% endif %}
                    </select>
                </div>

                <div class="col-md-3 px-3">
                    <label class="form-label small fw-bold text-muted text-uppercase mb-1">Region / SBU</label>
                    {% with field_name="sbu" options=sbus selected=selected_sbus %}
                        {% include "core/components/filter_dropdown.html" %}
                    {% endwith %}
                </div>

                <div class="col-md-3 ps-3 border-start">
                    <label class="form-label small fw-bold text-muted text-uppercase mb-1">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold shadow-sm">
                            <i class="fas fa-sync-alt me-2"></i>Update
                        </button>
                        {% if has_overrides %}
                            <button type="submit" name="reset_thresholds" value="true" class="btn btn-outline-danger btn-sm shadow-sm" title="Reset to Defaults">
                                <i class="fas fa-undo"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>

                <div class="col-12 mt-4 pt-3 border-top">
                    <div class="row g-3">
                        {% if view_mode == 'Sales' %}
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Sales Head</label>
                                {% with field_name="f_s_head" options=people_opts.s_head selected=selected_filters.s_head %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Sales Lead</label>
                                {% with field_name="f_s_lead" options=people_opts.s_lead selected=selected_filters.s_lead %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>

                        {% elif view_mode == 'Design' %}
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Interior Designers - ID</label>
                                {% with field_name="f_d_id" options=people_opts.d_id selected=selected_filters.d_id %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">3D Visualizers - 3D</label>
                                {% with field_name="f_d_3d" options=people_opts.d_3d selected=selected_filters.d_3d %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Design Managers - DM</label>
                                {% with field_name="f_d_dm" options=people_opts.d_dm selected=selected_filters.d_dm %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Design Heads - DH</label>
                                {% with field_name="f_d_dh" options=people_opts.d_dh selected=selected_filters.d_dh %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>

                        {% elif view_mode == 'Operations' %}
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Cluster/BU Heads</label>
                                {% with field_name="f_o_head" options=people_opts.o_head selected=selected_filters.o_head %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Senior/Project Managers - SPM/PM</label>
                                {% with field_name="f_o_pm" options=people_opts.o_pm selected=selected_filters.o_pm %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Senior Ops Managers - SOM/OM</label>
                                {% with field_name="f_o_om" options=people_opts.o_om selected=selected_filters.o_om %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">MEP</label>
                                {% with field_name="f_o_mep" options=people_opts.o_mep selected=selected_filters.o_mep %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">CSC</label>
                                {% with field_name="f_o_csc" options=people_opts.o_csc selected=selected_filters.o_csc %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Site Supervisors - SS</label>
                                {% with field_name="f_o_ss" options=people_opts.o_ss selected=selected_filters.o_ss %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>

                        {% elif view_mode == 'Marketing' %}
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Marketing Head</label>
                                {% with field_name="f_m_head" options=people_opts.m_head selected=selected_filters.m_head %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted mb-1">Marketing Lead</label>
                                {% with field_name="f_m_lead" options=people_opts.m_lead selected=selected_filters.m_lead %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>

                        {% elif view_mode == 'Purchase' %}
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted mb-1">Purchase Head</label>
                                {% with field_name="f_p_head" options=people_opts.p_head selected=selected_filters.p_head %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted mb-1">Manager</label>
                                {% with field_name="f_p_mgr" options=people_opts.p_mgr selected=selected_filters.p_mgr %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted mb-1">Executive</label>
                                {% with field_name="f_p_exec" options=people_opts.p_exec selected=selected_filters.p_exec %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>

                        {% elif view_mode == 'Finance' %}
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted mb-1">Finance Head</label>
                                {% with field_name="f_f_head" options=people_opts.f_head selected=selected_filters.f_head %}{% include "core/components/filter_dropdown.html" %}{% endwith %}
                            </div>

                        {% else %}
                            <div class="col-12 text-muted small fst-italic">No specific people filters for this view.</div>
                        {% endif %}
                    </div>
                </div>

            </form>
        </div>
    </div>

    <form method="GET" action="{% url 'dashboard' %}" id="dashboard-form">
        <input type="hidden" name="view" value="{{ view_mode }}"><input type="hidden" name="start" value="{{ start_date }}"><input type="hidden" name="end" value="{{ end_date }}">
        <input type="hidden" name="metric_role" value="{{ current_role }}">
        {% for s in selected_sbus %}<input type="hidden" name="sbu" value="{{ s }}">{% endfor %}
        {% for k, v in selected_filters.items %}{% for val in v %}<input type="hidden" name="f_{{ k }}" value="{{ val }}">{% endfor %}{% endfor %}

        {% if pre_prim or pre_sec %}
            <div class="animate-enter">
                {% include "core/components/metric_section.html" with title="Pre-Stage Analysis" icon_class="fas fa-hourglass-start" count=pre_count prim_list=pre_prim sec_list=pre_sec section_id="PreSec" is_post=False %}
            </div>
        {% endif %}

        {% if post_prim or post_sec %}
            <div class="animate-enter delay-1">
                {% include "core/components/metric_section.html" with title="Execution & Performance" icon_class="fas fa-cogs" count=post_count prim_list=post_prim sec_list=post_sec section_id="PostSec" is_post=True %}
            </div>
        {% endif %}
    </form>

    {% if not pre_prim and not post_prim %}
        <div class="text-center py-5 animate-enter">
            <div class="mb-3 text-muted opacity-50"><i class="fas fa-search fa-3x"></i></div>
            <h5 class="fw-bold text-muted">No Data Found</h5>
            <p class="small text-muted">Adjust your date range or filters to see metrics.</p>
        </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, { sanitize: false, html: true })
        });
        
        document.querySelectorAll('.count-up').forEach(c => {
            const target = +c.getAttribute('data-target');
            let cur = 0; const inc = Math.max(1, target / 30); 
            const upd = () => { cur += inc; if(cur < target) { c.innerText = Math.ceil(cur); requestAnimationFrame(upd); } else { c.innerText = target; } };
            upd();
        });

        const dateSpans = document.querySelectorAll('.formatted-date');
        
        dateSpans.forEach(span => {
            const rawDate = span.getAttribute('data-date'); 
            if(rawDate) {
                const dateObj = new Date(rawDate);
                
                const day = dateObj.getDate();
                const month = dateObj.toLocaleString('default', { month: 'long' });
                const year = dateObj.getFullYear();
                
                let suffix = 'th';
                if (day % 10 === 1 && day !== 11) suffix = 'st';
                else if (day % 10 === 2 && day !== 12) suffix = 'nd';
                else if (day % 10 === 3 && day !== 13) suffix = 'rd';
                
                span.innerText = `${day}${suffix} ${month} ${year}`;
            }
        });
    });

    function filterDropdown(inputId) {
        const dropdownMenu = document.getElementById('dd_' + inputId); if(!dropdownMenu) return; 
        const input = dropdownMenu.querySelector('.dropdown-search-box input');
        const filter = input.value.toLowerCase();
        const items = dropdownMenu.querySelectorAll('.dropdown-item-text');
        items.forEach(item => { const text = item.innerText.toLowerCase(); item.style.display = text.includes(filter) ? "" : "none"; });
    }
    function toggleAll(fieldId) {
        const container = document.getElementById('dd_' + fieldId); if(!container) return;
        const selectAllCheckbox = container.querySelector('.select-all');
        const visibleItems = Array.from(container.querySelectorAll('.dropdown-item-text')).filter(item => item.style.display !== 'none');
        visibleItems.forEach(item => { item.querySelector('input[type="checkbox"]').checked = selectAllCheckbox.checked; });
        updateBtn(fieldId);
    }
    function updateBtn(fieldId) {
        const container = document.getElementById('dd_' + fieldId); if(!container) return;
        const count = container.querySelectorAll('.item-checkbox:checked').length;
        const button = container.querySelector('button .btn-label');
        if(button) button.innerText = count > 0 ? `${count} Selected` : 'Select...';
    }
</script>
{% endblock %}