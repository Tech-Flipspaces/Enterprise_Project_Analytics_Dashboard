<div class="metric-card {% if is_post %}card-post{% else %}card-pre{% endif %} d-flex flex-column justify-content-between h-100 position-relative p-4 rounded-4 shadow-sm" 
     style="background-color: var(--card-bg); transition: transform 0.2s;">
    
    <div>
        <h6 class="text-muted fw-bold small text-truncate mb-2" title="{{ card.label }}">
            {{ card.label }}
        </h6>
        
        <div class="d-flex align-items-baseline">
            <h2 class="display-6 fw-bold mb-0 text-body count-up" data-target="{{ card.count }}">0</h2>
            <small class="text-muted ms-2 fw-bold" style="font-size: 0.7rem;">PROJECTS</small>
        </div>
    </div>

    <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center" style="border-color: var(--border-color) !important;">
        
        <form method="GET" class="d-flex align-items-center" style="max-width: 50%;">
            <input type="hidden" name="view" value="{{ request.GET.view }}">
            <input type="hidden" name="start" value="{{ request.GET.start }}">
            <input type="hidden" name="end" value="{{ request.GET.end }}">
            <input type="hidden" name="metric_role" value="{{ request.GET.metric_role }}">
            {% for s in request.GET.getlist.sbu %}<input type="hidden" name="sbu" value="{{ s }}">{% endfor %}
            {% for k, v in request.GET.items %}
                {% if 'f_' in k %}<input type="hidden" name="{{ k }}" value="{{ v }}">{% endif %}
            {% endfor %}

            <i class="fas fa-filter text-muted opacity-50 me-2" style="font-size: 0.7rem;"></i>
            <input type="number" step="0.1" name="{{ card.param }}" value="{{ card.threshold }}" 
                   class="form-control form-control-sm border-0 bg-transparent p-0 fw-bold text-primary shadow-none" 
                   style="width: 100%;"
                   onchange="this.form.submit()">
        </form>

        <button type="button" 
                class="btn btn-sm btn-link text-decoration-none p-0 text-muted hover-primary"
                data-bs-toggle="popover" 
                data-bs-trigger="click"
                data-bs-auto-close="outside"    
                data-bs-placement="top"
                data-bs-html="true"
                data-bs-custom-class="shadow-lg"
                title="<div class='d-flex justify-content-between align-items-center small fw-bold'><span>{{ card.label }}</span><span class='badge bg-primary'>{{ card.count }}</span></div>"
                
                data-bs-content="<div class='custom-scrollbar' style='max-height:200px; overflow-y:auto;'>
                    {% if card.project_list %}
                        <ul class='list-unstyled mb-0 small'>
                        {% for p in card.project_list %}
                            <li class='border-bottom py-2' style='border-color: var(--border-color) !important;'>
                                <a href='{% url 'project_scorecard' p.project_code %}?metric_role={{ request.GET.metric_role|default:'All Roles' }}' 
                                   class='text-decoration-none text-body d-block hover-primary fw-medium'>
                                    {{ p.project_name }}
                                </a>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <div class='text-muted fst-italic small text-center py-2'>No projects found.</div>
                    {% endif %}
                </div>">
            List <i class="fas fa-list-ul ms-1"></i>
        </button>
    </div>

    {% if card.success_cat %}
        <span class="position-absolute top-0 end-0 mt-3 me-3 badge rounded-pill border
                     bg-{{ card.success_color|default:'secondary' }} bg-opacity-10 text-{{ card.success_color|default:'secondary' }}">
            {{ card.success_cat }}
        </span>
    {% endif %}
</div>